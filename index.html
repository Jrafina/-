<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人记账系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3a0ca3;
            --success-color: #4cc9f0;
            --expense-color: #f72585;
            --income-color: #2ec4b6;
            --light-color: #f8f9fa;
            --dark-color: #212529;
            --gray-color: #6c757d;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        
        body {
            background-color: #f5f7ff;
            color: var(--dark-color);
            line-height: 1.6;
            padding-bottom: 40px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 1.5rem 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 2rem;
        }
        
        .logo h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .total-balance {
            text-align: right;
        }
        
        .total-balance h3 {
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .total-amount {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }
        
        @media (max-width: 992px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background-color: white;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            padding: 25px;
            margin-bottom: 25px;
            transition: var(--transition);
        }
        
        .card:hover {
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.12);
        }
        
        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 1.4rem;
            font-weight: 600;
        }
        
        .card-title i {
            font-size: 1.2rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: var(--transition);
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3ab4d8;
        }
        
        .btn-expense {
            background-color: var(--expense-color);
            color: white;
        }
        
        .btn-income {
            background-color: var(--income-color);
            color: white;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-group .btn {
            flex: 1;
        }
        
        .bank-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .bank-card {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }
        
        .bank-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15);
        }
        
        .bank-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%);
        }
        
        .bank-card h3 {
            font-size: 1.2rem;
            margin-bottom: 15px;
        }
        
        .bank-balance {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .bank-number {
            font-family: monospace;
            font-size: 0.9rem;
            opacity: 0.9;
            margin-top: 10px;
        }
        
        .delete-bank {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .delete-bank:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .records-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: var(--transition);
        }
        
        .record-item:hover {
            background-color: #f8f9fa;
        }
        
        .record-info {
            flex: 1;
        }
        
        .record-amount {
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .record-expense {
            color: var(--expense-color);
        }
        
        .record-income {
            color: var(--income-color);
        }
        
        .record-bank {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-top: 5px;
        }
        
        .record-remark {
            font-size: 0.95rem;
            margin-top: 5px;
            color: #555;
        }
        
        .record-date {
            font-size: 0.85rem;
            color: var(--gray-color);
            margin-right: 10px;
        }
        
        .record-actions {
            display: flex;
            gap: 5px;
        }
        
        .record-delete-btn {
            background: transparent;
            border: none;
            color: #dc3545;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: var(--transition);
        }
        
        .record-delete-btn:hover {
            background-color: rgba(220, 53, 69, 0.1);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray-color);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #dee2e6;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .stat-box {
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .stat-box h4 {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-bottom: 8px;
        }
        
        .stat-amount {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .gist-config {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .gist-config h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .gist-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        /* 添加固定提示容器样式 */
        .alerts-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 350px;
            z-index: 1000;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .alert {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.3s ease-out;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        
        .alert-info {
            background-color: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }
        
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }
        
        .type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .type-expense {
            background-color: rgba(247, 37, 133, 0.1);
            color: var(--expense-color);
        }
        
        .type-income {
            background-color: rgba(46, 196, 182, 0.1);
            color: var(--income-color);
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e9ecef;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-color);
            transition: var(--transition);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            color: var(--gray-color);
            font-size: 0.9rem;
        }
        
        .debug-panel {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-size: 0.85rem;
            display: none;
        }
        
        .debug-panel.visible {
            display: block;
        }
        
        .debug-panel h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .debug-btn {
            background-color: #6c757d;
            color: white;
            padding: 8px 12px;
            font-size: 0.8rem;
        }
        
        .debug-btn:hover {
            background-color: #5a6268;
        }
        
        .token-info {
            font-size: 0.8rem;
            color: var(--gray-color);
            margin-top: 5px;
        }
        
        .delete-all-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
        }
        
        .data-inspector {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 0.85rem;
            display: none;
        }
        
        .data-inspector.visible {
            display: block;
        }
        
        .data-inspector h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .data-content {
            background-color: #f1f3f4;
            padding: 10px;
            border-radius: 5px;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
            margin-top: 10px;
        }
        
        .debug-toggle-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
        }
        
        .debug-actions {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }
        
        .debug-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        /* 新增的当月消费统计样式 */
        .monthly-consumption {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .monthly-stat {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            flex: 1;
            min-width: 250px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .monthly-stat h3 {
            font-size: 1rem;
            margin-bottom: 10px;
            opacity: 0.9;
        }
        
        .monthly-amount {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .monthly-detail {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .total-balance {
                text-align: left;
            }
            
            .bank-cards {
                grid-template-columns: 1fr;
            }
            
            .stats {
                grid-template-columns: 1fr 1fr;
            }
            
            .gist-actions {
                flex-direction: column;
            }
            
            .alerts-container {
                width: 90%;
                right: 5%;
                left: 5%;
            }
            
            .record-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .record-actions {
                align-self: flex-end;
                margin-top: 10px;
            }
            
            .debug-actions {
                flex-direction: column;
            }
            
            .monthly-stat {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- 添加固定提示容器 -->
    <div class="alerts-container" id="alertsContainer"></div>
    
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-money-check-alt"></i>
                    <h1>个人记账系统</h1>
                </div>
                <div class="total-balance">
                    <h3>总余额</h3>
                    <div class="total-amount">¥ <span id="totalBalance">0.00</span></div>
                </div>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- GitHub Gist配置区域 -->
        <div class="gist-config card">
            <h3><i class="fab fa-github"></i> GitHub Gist 数据存储</h3>
            <p>将您的记账数据存储在GitHub Gist中，实现跨设备同步。</p>
            <p class="token-info">
                <strong>如何获取GitHub Token：</strong><br>
                1. 登录GitHub → Settings → Developer settings → Personal access tokens → Tokens (classic)<br>
                2. 点击"Generate new token" → 选择"Generate new token (classic)"<br>
                3. 给token命名（如"记账系统"），勾选<strong>gist</strong>权限<br>
                4. 点击"Generate token"，复制生成的token（只显示一次）
            </p>
            <div class="form-group">
                <label for="gistToken">GitHub Personal Access Token</label>
                <input type="password" id="gistToken" class="form-control" placeholder="输入您的GitHub令牌">
            </div>
            <div class="form-group">
                <label for="gistId">Gist ID (可选，留空将创建新的Gist)</label>
                <input type="text" id="gistId" class="form-control" placeholder="输入现有Gist ID或留空创建新Gist">
            </div>
            <div class="gist-actions">
                <button class="btn btn-primary" id="saveGistConfig">
                    <i class="fas fa-save"></i> 保存配置
                </button>
                <button class="btn btn-success" id="loadFromGist">
                    <i class="fas fa-cloud-download-alt"></i> 从Gist加载
                </button>
                <button class="btn" id="saveToGist">
                    <i class="fas fa-cloud-upload-alt"></i> 保存到Gist
                </button>
                <button class="btn debug-btn" id="testGistConnection">
                    <i class="fas fa-bug"></i> 测试连接
                </button>
                <button class="btn debug-btn" id="inspectGistData">
                    <i class="fas fa-search"></i> 检查Gist数据
                </button>
            </div>
        </div>
        
        <!-- 当月消费统计 -->
        <div class="monthly-consumption">
            <div class="monthly-stat">
                <h3><i class="fas fa-calendar-alt"></i> 当月总消费</h3>
                <div class="monthly-amount">¥ <span id="monthlyTotalExpense">0.00</span></div>
                <div class="monthly-detail">本月已消费总额</div>
            </div>
            <div class="monthly-stat" style="background: linear-gradient(135deg, #f72585 0%, #b5179e 100%);">
                <h3><i class="fas fa-chart-line"></i> 当月平均消费</h3>
                <div class="monthly-amount">¥ <span id="monthlyAverageExpense">0.00</span></div>
                <div class="monthly-detail">平均每天 <span id="dailyAverageExpense">0.00</span> 元</div>
            </div>
            <div class="monthly-stat" style="background: linear-gradient(135deg, #4cc9f0 0%, #3a86ff 100%);">
                <h3><i class="fas fa-info-circle"></i> 当月消费信息</h3>
                <div class="monthly-amount" style="font-size: 1.4rem;">本月第 <span id="currentDay">1</span> 天</div>
                <div class="monthly-detail">本月消费天数: <span id="consumptionDays">0</span> 天</div>
            </div>
        </div>
        
        <!-- 调试面板开关 -->
        <div class="debug-toggle-container">
            <button class="btn btn-warning" id="toggleDebugPanel">
                <i class="fas fa-code"></i> 显示调试面板
            </button>
        </div>
        
        <!-- 调试面板 -->
        <div class="debug-panel" id="debugPanel">
            <div class="debug-header">
                <h4><i class="fas fa-bug"></i> 调试信息</h4>
                <div class="debug-actions">
                    <button class="btn debug-btn" id="exportDebugLog">
                        <i class="fas fa-download"></i> 导出日志
                    </button>
                    <button class="btn debug-btn" id="clearDebug">
                        <i class="fas fa-trash"></i> 清除日志
                    </button>
                </div>
            </div>
            <div id="debugInfo"></div>
        </div>
        
        <!-- 数据检查器 -->
        <div class="data-inspector" id="dataInspector">
            <h4><i class="fas fa-search"></i> 数据检查</h4>
            <div id="dataContent" class="data-content"></div>
            <button class="btn debug-btn" id="clearDataInspector">
                <i class="fas fa-times"></i> 关闭检查器
            </button>
        </div>
        
        <!-- 统计信息 -->
        <div class="stats">
            <div class="stat-box">
                <h4>总收入</h4>
                <div class="stat-amount income-color">¥ <span id="totalIncome">0.00</span></div>
            </div>
            <div class="stat-box">
                <h4>总支出</h4>
                <div class="stat-amount expense-color">¥ <span id="totalExpense">0.00</span></div>
            </div>
            <div class="stat-box">
                <h4>银行卡数量</h4>
                <div class="stat-amount"> <span id="bankCount">0</span> 张</div>
            </div>
            <div class="stat-box">
                <h4>交易记录</h4>
                <div class="stat-amount"> <span id="recordCount">0</span> 笔</div>
            </div>
        </div>
        
        <!-- 选项卡 -->
        <div class="tabs">
            <div class="tab active" data-target="bank-section">银行卡管理</div>
            <div class="tab" data-target="record-section">记账记录</div>
            <div class="tab" data-target="history-section">历史记录</div>
        </div>
        
        <!-- 银行卡管理 -->
        <div class="tab-content active" id="bank-section">
            <div class="main-content">
                <!-- 添加银行卡 -->
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-credit-card"></i> 添加银行卡</h2>
                    <div class="form-group">
                        <label for="bankName">银行名称</label>
                        <input type="text" id="bankName" class="form-control" placeholder="例如：中国银行">
                    </div>
                    <div class="form-group">
                        <label for="cardNumber">卡号 (后4位)</label>
                        <input type="text" id="cardNumber" class="form-control" placeholder="例如：1234" maxlength="4">
                    </div>
                    <div class="form-group">
                        <label for="initialBalance">初始余额</label>
                        <input type="number" id="initialBalance" class="form-control" placeholder="0.00" step="0.01" min="0">
                    </div>
                    <button class="btn btn-primary" id="addBankBtn">
                        <i class="fas fa-plus-circle"></i> 添加银行卡
                    </button>
                </div>
                
                <!-- 银行卡列表 -->
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-wallet"></i> 我的银行卡</h2>
                    <div id="bankList" class="bank-cards">
                        <!-- 银行卡将通过JS动态添加 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 记账记录 -->
        <div class="tab-content" id="record-section">
            <div class="main-content">
                <!-- 添加记录 -->
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-edit"></i> 添加记账记录</h2>
                    <div class="form-group">
                        <label for="recordBank">选择银行卡</label>
                        <select id="recordBank" class="form-control">
                            <option value="">请选择银行卡</option>
                            <!-- 银行卡选项将通过JS动态添加 -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="recordType">收支类型</label>
                        <select id="recordType" class="form-control">
                            <option value="expense">支出</option>
                            <option value="income">收入</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="recordAmount">金额</label>
                        <input type="number" id="recordAmount" class="form-control" placeholder="0.00" step="0.01" min="0.01">
                    </div>
                    <div class="form-group">
                        <label for="recordRemark">备注</label>
                        <input type="text" id="recordRemark" class="form-control" placeholder="例如：餐饮、购物、工资等">
                    </div>
                    
                    <div class="form-group">
                        <label>当前卡余额</label>
                        <div id="currentBalance" class="form-control" style="background-color:#f8f9fa; font-weight:bold;">
                            请先选择银行卡
                        </div>
                    </div>
                    
                    <div class="btn-group">
                        <button class="btn btn-expense" id="addExpenseBtn">
                            <i class="fas fa-minus-circle"></i> 添加支出
                        </button>
                        <button class="btn btn-income" id="addIncomeBtn">
                            <i class="fas fa-plus-circle"></i> 添加收入
                        </button>
                    </div>
                </div>
                
                <!-- 最近记录 -->
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-history"></i> 最近记录</h2>
                    <div id="recentRecords" class="records-list">
                        <!-- 记录将通过JS动态添加 -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 历史记录 -->
        <div class="tab-content" id="history-section">
            <div class="card">
                <div class="delete-all-container">
                    <button class="btn btn-danger" id="deleteAllRecordsBtn">
                        <i class="fas fa-trash-alt"></i> 删除所有记录
                    </button>
                </div>
                <h2 class="card-title"><i class="fas fa-list-alt"></i> 所有交易记录</h2>
                <div id="allRecords" class="records-list">
                    <!-- 记录将通过JS动态添加 -->
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="container">
            <p>个人记账系统 &copy; 2023 - 数据存储于GitHub Gist</p>
        </div>
    </footer>
    
    <script>
        // 应用状态
        const state = {
            banks: [],
            records: [],
            gistToken: localStorage.getItem('gistToken') || '',
            gistId: localStorage.getItem('gistId') || '',
            debugPanelVisible: localStorage.getItem('debugPanelVisible') === 'true' || false,
            dataInspectorVisible: localStorage.getItem('dataInspectorVisible') === 'true' || false,
            totalBalance: 0,
            totalIncome: 0,
            totalExpense: 0,
            monthlyTotalExpense: 0, // 新增：当月总消费
            monthlyAverageExpense: 0, // 新增：当月平均消费
            dailyAverageExpense: 0, // 新增：日均消费
            currentDay: 1, // 新增：当前日期
            consumptionDays: 0 // 新增：本月消费天数
        };
        
        // DOM元素
        const elements = {
            totalBalance: document.getElementById('totalBalance'),
            totalIncome: document.getElementById('totalIncome'),
            totalExpense: document.getElementById('totalExpense'),
            bankCount: document.getElementById('bankCount'),
            recordCount: document.getElementById('recordCount'),
            bankList: document.getElementById('bankList'),
            recordBank: document.getElementById('recordBank'),
            currentBalance: document.getElementById('currentBalance'),
            recentRecords: document.getElementById('recentRecords'),
            allRecords: document.getElementById('allRecords'),
            addBankBtn: document.getElementById('addBankBtn'),
            addExpenseBtn: document.getElementById('addExpenseBtn'),
            addIncomeBtn: document.getElementById('addIncomeBtn'),
            deleteAllRecordsBtn: document.getElementById('deleteAllRecordsBtn'),
            bankName: document.getElementById('bankName'),
            cardNumber: document.getElementById('cardNumber'),
            initialBalance: document.getElementById('initialBalance'),
            recordAmount: document.getElementById('recordAmount'),
            recordRemark: document.getElementById('recordRemark'),
            recordType: document.getElementById('recordType'),
            gistToken: document.getElementById('gistToken'),
            gistId: document.getElementById('gistId'),
            saveGistConfig: document.getElementById('saveGistConfig'),
            loadFromGist: document.getElementById('loadFromGist'),
            saveToGist: document.getElementById('saveToGist'),
            testGistConnection: document.getElementById('testGistConnection'),
            inspectGistData: document.getElementById('inspectGistData'),
            debugPanel: document.getElementById('debugPanel'),
            debugInfo: document.getElementById('debugInfo'),
            clearDebug: document.getElementById('clearDebug'),
            exportDebugLog: document.getElementById('exportDebugLog'),
            alertsContainer: document.getElementById('alertsContainer'),
            dataInspector: document.getElementById('dataInspector'),
            dataContent: document.getElementById('dataContent'),
            clearDataInspector: document.getElementById('clearDataInspector'),
            toggleDebugPanel: document.getElementById('toggleDebugPanel'),
            // 新增：当月消费相关元素
            monthlyTotalExpense: document.getElementById('monthlyTotalExpense'),
            monthlyAverageExpense: document.getElementById('monthlyAverageExpense'),
            dailyAverageExpense: document.getElementById('dailyAverageExpense'),
            currentDay: document.getElementById('currentDay'),
            consumptionDays: document.getElementById('consumptionDays')
        };
        
        // 调试日志
        function debugLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            if (type === 'error') {
                logEntry.style.color = '#dc3545';
                logEntry.style.fontWeight = 'bold';
            } else if (type === 'success') {
                logEntry.style.color = '#28a745';
            } else if (type === 'warning') {
                logEntry.style.color = '#ffc107';
            } else if (type === 'debug') {
                logEntry.style.color = '#6c757d';
                logEntry.style.fontStyle = 'italic';
            }
            
            if (elements.debugInfo) {
                elements.debugInfo.prepend(logEntry);
                
                // 确保调试面板可见
                if (state.debugPanelVisible) {
                    elements.debugPanel.classList.add('visible');
                }
                
                // 限制日志数量，最多保留100条
                const logs = elements.debugInfo.querySelectorAll('div');
                if (logs.length > 100) {
                    for (let i = 100; i < logs.length; i++) {
                        logs[i].remove();
                    }
                }
            }
            
            // 同时输出到控制台
            console.log(`[${timestamp}] ${message}`);
        }
        
        // 切换调试面板
        function toggleDebugPanel() {
            state.debugPanelVisible = !state.debugPanelVisible;
            
            if (state.debugPanelVisible) {
                elements.debugPanel.classList.add('visible');
                elements.toggleDebugPanel.innerHTML = '<i class="fas fa-code"></i> 隐藏调试面板';
                elements.toggleDebugPanel.classList.add('btn-warning');
                debugLog('调试面板已显示', 'debug');
            } else {
                elements.debugPanel.classList.remove('visible');
                elements.toggleDebugPanel.innerHTML = '<i class="fas fa-code"></i> 显示调试面板';
                elements.toggleDebugPanel.classList.remove('btn-warning');
                elements.toggleDebugPanel.classList.add('btn-warning');
            }
            
            // 保存状态到本地存储
            localStorage.setItem('debugPanelVisible', state.debugPanelVisible);
        }
        
        // 显示数据检查器
        function showDataInspector(content, title = '数据内容') {
            state.dataInspectorVisible = true;
            elements.dataContent.textContent = content;
            elements.dataInspector.classList.add('visible');
            localStorage.setItem('dataInspectorVisible', true);
            debugLog(`显示数据检查器: ${title}`, 'info');
        }
        
        // 隐藏数据检查器
        function hideDataInspector() {
            state.dataInspectorVisible = false;
            elements.dataInspector.classList.remove('visible');
            localStorage.setItem('dataInspectorVisible', false);
            debugLog('数据检查器已隐藏', 'debug');
        }
        
        // 导出调试日志
        function exportDebugLog() {
            const logs = elements.debugInfo.innerText;
            if (!logs.trim()) {
                showAlert('暂无调试日志可导出', 'warning');
                return;
            }
            
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `debug_log_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert('调试日志导出成功', 'success');
            debugLog('调试日志已导出', 'success');
        }
        
        // 清除调试日志
        function clearDebugLog() {
            if (elements.debugInfo) {
                elements.debugInfo.innerHTML = '';
                showAlert('调试日志已清除', 'success');
                debugLog('调试日志已清除', 'debug');
            }
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('应用初始化开始', 'info');
            initApp();
            setupEventListeners();
            loadFromLocalStorage();
            updateUI();
            debugLog('应用初始化完成', 'success');
        });
        
        // 初始化应用
        function initApp() {
            debugLog('初始化应用配置', 'info');
            
            // 设置Gist配置
            if (state.gistToken) {
                elements.gistToken.value = state.gistToken;
                debugLog('从本地存储加载了GitHub Token', 'success');
            } else {
                debugLog('未找到GitHub Token，请配置', 'warning');
            }
            
            if (state.gistId) {
                elements.gistId.value = state.gistId;
                debugLog(`从本地存储加载了Gist ID: ${state.gistId}`, 'success');
            }
            
            // 初始化调试面板状态
            if (state.debugPanelVisible) {
                elements.debugPanel.classList.add('visible');
                elements.toggleDebugPanel.innerHTML = '<i class="fas fa-code"></i> 隐藏调试面板';
                debugLog('调试面板已恢复显示', 'debug');
            } else {
                elements.debugPanel.classList.remove('visible');
                elements.toggleDebugPanel.innerHTML = '<i class="fas fa-code"></i> 显示调试面板';
            }
            
            // 初始化数据检查器状态
            if (state.dataInspectorVisible) {
                elements.dataInspector.classList.add('visible');
            }
            
            // 初始化选项卡
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    
                    // 移除所有active类
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                    
                    // 添加active类到当前选项卡
                    this.classList.add('active');
                    document.getElementById(targetId).classList.add('active');
                    
                    debugLog(`切换到选项卡: ${targetId}`, 'debug');
                });
            });
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            debugLog('设置事件监听器', 'info');
            
            // 添加银行卡
            elements.addBankBtn.addEventListener('click', addBank);
            
            // 添加支出
            elements.addExpenseBtn.addEventListener('click', function() {
                addRecord('expense');
            });
            
            // 添加收入
            elements.addIncomeBtn.addEventListener('click', function() {
                addRecord('income');
            });
            
            // 删除所有记录
            if (elements.deleteAllRecordsBtn) {
                elements.deleteAllRecordsBtn.addEventListener('click', deleteAllRecords);
            }
            
            // 检查Gist数据
            if (elements.inspectGistData) {
                elements.inspectGistData.addEventListener('click', inspectGistData);
            }
            
            // 关闭数据检查器
            if (elements.clearDataInspector) {
                elements.clearDataInspector.addEventListener('click', hideDataInspector);
            }
            
            // 切换调试面板
            if (elements.toggleDebugPanel) {
                elements.toggleDebugPanel.addEventListener('click', toggleDebugPanel);
            }
            
            // 导出调试日志
            if (elements.exportDebugLog) {
                elements.exportDebugLog.addEventListener('click', exportDebugLog);
            }
            
            // 清除调试日志
            if (elements.clearDebug) {
                elements.clearDebug.addEventListener('click', clearDebugLog);
            }
            
            // 银行卡选择变化
            elements.recordBank.addEventListener('change', updateCurrentBalance);
            
            // Gist配置
            elements.saveGistConfig.addEventListener('click', saveGistConfig);
            elements.loadFromGist.addEventListener('click', loadFromGist);
            elements.saveToGist.addEventListener('click', saveToGist);
            elements.testGistConnection.addEventListener('click', testGistConnection);
            
            debugLog('事件监听器设置完成', 'success');
        }
        
        // 检查Gist数据
        async function inspectGistData() {
            if (!state.gistToken) {
                showAlert('请先配置GitHub Token', 'error');
                debugLog('检查Gist数据失败: 未配置Token', 'error');
                return;
            }
            
            if (!state.gistId) {
                showAlert('请先配置Gist ID', 'error');
                debugLog('检查Gist数据失败: 未配置Gist ID', 'error');
                return;
            }
            
            try {
                showAlert('正在检查Gist数据...', 'info');
                debugLog(`检查Gist数据: ${state.gistId}`, 'info');
                
                const response = await fetch(`https://api.github.com/gists/${state.gistId}`, {
                    headers: {
                        'Authorization': `token ${state.gistToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                }
                
                const gistData = await response.json();
                
                // 显示Gist的完整信息
                const gistInfo = {
                    id: gistData.id,
                    description: gistData.description,
                    created_at: gistData.created_at,
                    updated_at: gistData.updated_at,
                    files: Object.keys(gistData.files),
                    raw_url: gistData.files[Object.keys(gistData.files)[0]]?.raw_url
                };
                
                debugLog(`Gist信息: ${JSON.stringify(gistInfo)}`, 'info');
                
                // 显示所有文件内容
                let fullContent = `Gist ID: ${gistData.id}\n`;
                fullContent += `描述: ${gistData.description || '无'}\n`;
                fullContent += `创建时间: ${gistData.created_at}\n`;
                fullContent += `更新时间: ${gistData.updated_at}\n`;
                fullContent += `文件列表: ${Object.keys(gistData.files).join(', ')}\n\n`;
                
                Object.keys(gistData.files).forEach(filename => {
                    const file = gistData.files[filename];
                    fullContent += `=== 文件: ${filename} ===\n`;
                    fullContent += `大小: ${file.size} 字节\n`;
                    fullContent += `类型: ${file.type}\n`;
                    fullContent += `内容:\n${file.content}\n\n`;
                });
                
                showDataInspector(fullContent, 'Gist完整数据');
                
                showAlert('Gist数据检查完成，请查看数据检查面板', 'success');
            } catch (error) {
                console.error('检查Gist数据失败:', error);
                debugLog(`检查Gist数据失败: ${error.message}`, 'error');
                showAlert(`检查Gist数据失败: ${error.message}`, 'error');
            }
        }
        
        // 添加银行卡
        function addBank() {
            const name = elements.bankName.value.trim();
            const cardNumber = elements.cardNumber.value.trim();
            const balance = parseFloat(elements.initialBalance.value);
            
            if (!name) {
                showAlert('请输入银行名称', 'error');
                debugLog('添加银行卡失败: 银行名称为空', 'error');
                return;
            }
            
            if (!cardNumber || cardNumber.length !== 4 || isNaN(parseInt(cardNumber))) {
                showAlert('请输入有效的4位卡号', 'error');
                debugLog('添加银行卡失败: 卡号无效', 'error');
                return;
            }
            
            if (isNaN(balance) || balance < 0) {
                showAlert('请输入有效的初始余额', 'error');
                debugLog('添加银行卡失败: 余额无效', 'error');
                return;
            }
            
            // 创建银行卡对象
            const bank = {
                id: Date.now().toString(),
                name: name,
                cardNumber: cardNumber,
                balance: balance
            };
            
            // 添加到状态
            state.banks.push(bank);
            
            // 清空表单
            elements.bankName.value = '';
            elements.cardNumber.value = '';
            elements.initialBalance.value = '';
            
            // 更新UI
            updateUI();
            saveToLocalStorage();
            
            showAlert('银行卡添加成功', 'success');
            debugLog(`添加银行卡: ${name} (****${cardNumber}), 余额: ¥${balance.toFixed(2)}`, 'success');
        }
        
        // 删除银行卡
        function deleteBank(id) {
            // 检查是否有该卡的交易记录
            const hasRecords = state.records.some(record => record.bankId === id);
            const bank = state.banks.find(b => b.id === id);
            
            if (hasRecords) {
                if (!confirm('该银行卡有交易记录，删除后将无法查看这些记录的银行卡信息。确定要删除吗？')) {
                    debugLog('取消删除银行卡', 'info');
                    return;
                }
            }
            
            // 从状态中移除
            state.banks = state.banks.filter(bank => bank.id !== id);
            
            // 更新UI
            updateUI();
            saveToLocalStorage();
            
            showAlert('银行卡删除成功', 'success');
            debugLog(`删除银行卡: ${bank ? bank.name : '未知'}`, 'success');
        }
        
        // 添加记录
        function addRecord(type) {
            const bankId = elements.recordBank.value;
            const amount = parseFloat(elements.recordAmount.value);
            const remark = elements.recordRemark.value.trim();
            
            if (!bankId) {
                showAlert('请选择银行卡', 'error');
                debugLog('添加记录失败: 未选择银行卡', 'error');
                return;
            }
            
            if (isNaN(amount) || amount <= 0) {
                showAlert('请输入有效的金额', 'error');
                debugLog('添加记录失败: 金额无效', 'error');
                return;
            }
            
            // 查找银行卡
            const bank = state.banks.find(b => b.id === bankId);
            if (!bank) {
                showAlert('银行卡不存在', 'error');
                debugLog('添加记录失败: 银行卡不存在', 'error');
                return;
            }
            
            // 检查支出是否超过余额
            if (type === 'expense' && amount > bank.balance) {
                showAlert('支出金额超过卡内余额', 'error');
                debugLog(`添加记录失败: 支出金额${amount}超过余额${bank.balance}`, 'error');
                return;
            }
            
            // 更新银行卡余额
            const oldBalance = bank.balance;
            if (type === 'expense') {
                bank.balance -= amount;
            } else {
                bank.balance += amount;
            }
            
            // 创建记录对象
            const record = {
                id: Date.now().toString(),
                bankId: bankId,
                bankName: bank.name,
                type: type,
                amount: amount,
                remark: remark || (type === 'expense' ? '支出' : '收入'),
                date: new Date().toISOString()
            };
            
            // 添加到状态
            state.records.unshift(record);
            
            // 清空表单
            elements.recordAmount.value = '';
            elements.recordRemark.value = '';
            
            // 更新UI
            updateUI();
            saveToLocalStorage();
            
            showAlert(`${type === 'expense' ? '支出' : '收入'}记录添加成功`, 'success');
            debugLog(`添加${type === 'expense' ? '支出' : '收入'}记录: ¥${amount.toFixed(2)}, 备注: ${remark || '无'}, 银行卡: ${bank.name}, 余额变化: ${oldBalance.toFixed(2)} -> ${bank.balance.toFixed(2)}`, 'success');
        }
        
        // 删除记录
        function deleteRecord(recordId) {
            // 查找记录
            const recordIndex = state.records.findIndex(r => r.id === recordId);
            if (recordIndex === -1) {
                showAlert('记录不存在', 'error');
                debugLog('删除记录失败: 记录不存在', 'error');
                return;
            }
            
            const record = state.records[recordIndex];
            
            // 查找对应的银行卡
            const bank = state.banks.find(b => b.id === record.bankId);
            if (!bank) {
                showAlert('关联的银行卡不存在', 'error');
                debugLog('删除记录失败: 关联的银行卡不存在', 'error');
                return;
            }
            
            // 确认删除
            if (!confirm(`确定要删除这条${record.type === 'expense' ? '支出' : '收入'}记录吗？\n金额: ¥${record.amount.toFixed(2)}\n备注: ${record.remark}`)) {
                debugLog('取消删除记录', 'info');
                return;
            }
            
            // 根据记录类型反向调整银行卡余额
            if (record.type === 'expense') {
                // 删除支出记录，余额增加
                bank.balance += record.amount;
            } else {
                // 删除收入记录，余额减少
                bank.balance -= record.amount;
            }
            
            // 从状态中删除记录
            state.records.splice(recordIndex, 1);
            
            // 更新UI
            updateUI();
            saveToLocalStorage();
            
            showAlert('记录删除成功', 'success');
            debugLog(`删除记录: ${record.type === 'expense' ? '支出' : '收入'} ¥${record.amount.toFixed(2)}, 银行卡: ${record.bankName}, 余额调整: ${record.type === 'expense' ? '+' : '-'}${record.amount.toFixed(2)}`, 'success');
        }
        
        // 删除所有记录
        function deleteAllRecords() {
            if (state.records.length === 0) {
                showAlert('暂无交易记录', 'info');
                return;
            }
            
            if (!confirm(`确定要删除所有 ${state.records.length} 条交易记录吗？\n此操作不可恢复！`)) {
                debugLog('取消删除所有记录', 'info');
                return;
            }
            
            // 重置所有银行卡余额到初始状态（需要重新计算）
            // 先备份当前银行卡
            const bankBackup = JSON.parse(JSON.stringify(state.banks));
            
            // 重置所有记录
            state.records = [];
            
            // 重新计算银行卡余额（根据初始余额）
            // 这里我们无法知道初始余额，所以保持当前余额不变
            // 在实际应用中，可能需要用户确认
            
            // 更新UI
            updateUI();
            saveToLocalStorage();
            
            showAlert(`已删除所有 ${state.records.length} 条交易记录`, 'success');
            debugLog('删除所有记录', 'success');
        }
        
        // 更新当前卡余额显示
        function updateCurrentBalance() {
            const bankId = elements.recordBank.value;
            
            if (!bankId) {
                elements.currentBalance.textContent = '请先选择银行卡';
                return;
            }
            
            const bank = state.banks.find(b => b.id === bankId);
            if (bank) {
                elements.currentBalance.textContent = `¥ ${bank.balance.toFixed(2)}`;
                elements.currentBalance.style.color = bank.balance >= 0 ? '#2ec4b6' : '#f72585';
            }
        }
        
        // 计算当月消费统计
        function calculateMonthlyConsumption() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            const currentDay = now.getDate();
            
            // 更新当前日期
            state.currentDay = currentDay;
            elements.currentDay.textContent = currentDay;
            
            // 筛选当月的支出记录
            const monthlyExpenses = state.records.filter(record => {
                if (record.type !== 'expense') return false;
                
                const recordDate = new Date(record.date);
                return (
                    recordDate.getFullYear() === currentYear &&
                    recordDate.getMonth() === currentMonth
                );
            });
            
            // 计算当月总消费
            state.monthlyTotalExpense = monthlyExpenses.reduce((sum, record) => sum + record.amount, 0);
            
            // 计算当月消费天数（有消费记录的天数）
            const expenseDays = new Set();
            monthlyExpenses.forEach(record => {
                const recordDate = new Date(record.date);
                expenseDays.add(recordDate.getDate());
            });
            state.consumptionDays = expenseDays.size;
            
            // 计算当月平均消费（当月总消费 / 当前日期数）
            state.monthlyAverageExpense = currentDay > 0 ? state.monthlyTotalExpense / currentDay : 0;
            
            // 计算日均消费（当月总消费 / 本月消费天数）
            state.dailyAverageExpense = state.consumptionDays > 0 ? state.monthlyTotalExpense / state.consumptionDays : 0;
            
            debugLog(`当月消费统计: 总消费=${state.monthlyTotalExpense.toFixed(2)}, 平均消费=${state.monthlyAverageExpense.toFixed(2)}, 消费天数=${state.consumptionDays}`, 'info');
        }
        
        // 更新UI
        function updateUI() {
            debugLog('开始更新UI', 'info');
            
            // 计算统计信息
            calculateStats();
            
            // 计算当月消费统计
            calculateMonthlyConsumption();
            
            // 更新统计显示
            elements.totalBalance.textContent = state.totalBalance.toFixed(2);
            elements.totalIncome.textContent = state.totalIncome.toFixed(2);
            elements.totalExpense.textContent = state.totalExpense.toFixed(2);
            elements.bankCount.textContent = state.banks.length;
            elements.recordCount.textContent = state.records.length;
            
            // 更新当月消费统计显示
            elements.monthlyTotalExpense.textContent = state.monthlyTotalExpense.toFixed(2);
            elements.monthlyAverageExpense.textContent = state.monthlyAverageExpense.toFixed(2);
            elements.dailyAverageExpense.textContent = state.dailyAverageExpense.toFixed(2);
            elements.consumptionDays.textContent = state.consumptionDays;
            
            // 更新银行卡列表
            renderBankList();
            
            // 更新银行卡选择下拉
            renderBankOptions();
            
            // 更新最近记录
            renderRecentRecords();
            
            // 更新所有记录
            renderAllRecords();
            
            // 更新当前卡余额
            updateCurrentBalance();
            
            debugLog('UI更新完成', 'success');
        }
        
        // 计算统计信息
        function calculateStats() {
            // 总余额 = 所有银行卡余额之和
            state.totalBalance = state.banks.reduce((sum, bank) => sum + bank.balance, 0);
            
            // 总收入和总支出
            state.totalIncome = state.records
                .filter(record => record.type === 'income')
                .reduce((sum, record) => sum + record.amount, 0);
                
            state.totalExpense = state.records
                .filter(record => record.type === 'expense')
                .reduce((sum, record) => sum + record.amount, 0);
        }
        
        // 渲染银行卡列表
        function renderBankList() {
            if (state.banks.length === 0) {
                elements.bankList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-credit-card"></i>
                        <p>暂无银行卡，请添加银行卡</p>
                    </div>
                `;
                return;
            }
            
            elements.bankList.innerHTML = state.banks.map(bank => `
                <div class="bank-card">
                    <button class="delete-bank" onclick="deleteBank('${bank.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                    <h3>${bank.name}</h3>
                    <div class="bank-balance">¥ ${bank.balance.toFixed(2)}</div>
                    <div class="bank-number">**** **** **** ${bank.cardNumber}</div>
                </div>
            `).join('');
        }
        
        // 渲染银行卡选项
        function renderBankOptions() {
            elements.recordBank.innerHTML = '<option value="">请选择银行卡</option>' +
                state.banks.map(bank => `
                    <option value="${bank.id}">${bank.name} (****${bank.cardNumber}) - ¥ ${bank.balance.toFixed(2)}</option>
                `).join('');
        }
        
        // 渲染最近记录
        function renderRecentRecords() {
            const recentRecords = state.records.slice(0, 5);
            
            if (recentRecords.length === 0) {
                elements.recentRecords.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-receipt"></i>
                        <p>暂无交易记录</p>
                    </div>
                `;
                return;
            }
            
            elements.recentRecords.innerHTML = recentRecords.map(record => `
                <div class="record-item">
                    <div class="record-info">
                        <div>
                            <span class="record-amount ${record.type === 'expense' ? 'record-expense' : 'record-income'}">
                                ${record.type === 'expense' ? '-' : '+'}¥ ${record.amount.toFixed(2)}
                            </span>
                            <span class="type-badge ${record.type === 'expense' ? 'type-expense' : 'type-income'}">
                                ${record.type === 'expense' ? '支出' : '收入'}
                            </span>
                        </div>
                        <div class="record-remark">${record.remark}</div>
                        <div class="record-bank">${record.bankName}</div>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <div class="record-date">${formatDate(record.date)}</div>
                        <div class="record-actions">
                            <button class="record-delete-btn" onclick="deleteRecord('${record.id}')" title="删除记录">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // 渲染所有记录
        function renderAllRecords() {
            if (state.records.length === 0) {
                elements.allRecords.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-receipt"></i>
                        <p>暂无交易记录</p>
                    </div>
                `;
                return;
            }
            
            elements.allRecords.innerHTML = state.records.map(record => `
                <div class="record-item">
                    <div class="record-info">
                        <div>
                            <span class="record-amount ${record.type === 'expense' ? 'record-expense' : 'record-income'}">
                                ${record.type === 'expense' ? '-' : '+'}¥ ${record.amount.toFixed(2)}
                            </span>
                            <span class="type-badge ${record.type === 'expense' ? 'type-expense' : 'type-income'}">
                                ${record.type === 'expense' ? '支出' : '收入'}
                            </span>
                        </div>
                        <div class="record-remark">${record.remark}</div>
                        <div class="record-bank">${record.bankName}</div>
                    </div>
                    <div style="display:flex; align-items:center;">
                        <div class="record-date">${formatDate(record.date)}</div>
                        <div class="record-actions">
                            <button class="record-delete-btn" onclick="deleteRecord('${record.id}')" title="删除记录">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')} ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`;
        }
        
        // 显示提示信息 - 修复后的版本
        function showAlert(message, type) {
            // 创建新的提示
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            // 确保提示容器存在
            if (!elements.alertsContainer) {
                // 如果不存在，创建一个
                elements.alertsContainer = document.createElement('div');
                elements.alertsContainer.className = 'alerts-container';
                elements.alertsContainer.id = 'alertsContainer';
                document.body.appendChild(elements.alertsContainer);
            }
            
            // 添加到提示容器
            elements.alertsContainer.appendChild(alert);
            
            debugLog(`显示提示: ${message} (${type})`, type);
            
            // 3秒后自动移除
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateX(100%)';
                    alert.style.transition = 'opacity 0.3s, transform 0.3s';
                    
                    setTimeout(() => {
                        if (alert.parentNode) {
                            alert.remove();
                        }
                    }, 300);
                }
            }, 3000);
        }
        
        // 保存到本地存储
        function saveToLocalStorage() {
            try {
                const appData = {
                    banks: state.banks,
                    records: state.records,
                    version: '2.0',
                    updatedAt: new Date().toISOString()
                };
                
                localStorage.setItem('accountingData', JSON.stringify(appData));
                debugLog('数据保存到本地存储', 'success');
                
                // 显示当前状态
                debugLog(`当前状态: ${state.banks.length} 张银行卡, ${state.records.length} 条记录`, 'info');
            } catch (e) {
                debugLog(`保存到本地存储失败: ${e.message}`, 'error');
            }
        }
        
        // 从本地存储加载
        function loadFromLocalStorage() {
            const savedData = localStorage.getItem('accountingData');
            
            if (savedData) {
                try {
                    const appData = JSON.parse(savedData);
                    
                    // 检查数据格式
                    if (!appData.banks || !appData.records) {
                        throw new Error('数据格式错误：缺少banks或records字段');
                    }
                    
                    state.banks = appData.banks || [];
                    state.records = appData.records || [];
                    
                    showAlert('本地数据加载成功', 'success');
                    debugLog('从本地存储加载数据成功', 'success');
                    debugLog(`加载了 ${state.banks.length} 张银行卡, ${state.records.length} 条记录`, 'info');
                    
                    // 显示数据内容用于调试
                    if (state.banks.length === 0) {
                        debugLog('警告: 从本地存储加载的银行卡数据为空', 'warning');
                    }
                    
                } catch (e) {
                    console.error('加载本地数据失败:', e);
                    showAlert('加载本地数据失败，已使用初始数据', 'error');
                    debugLog(`加载本地数据失败: ${e.message}`, 'error');
                    loadExampleData();
                }
            } else {
                loadExampleData();
            }
        }
        
        // 加载示例数据
        function loadExampleData() {
            // 初始示例数据
            state.banks = [
                { id: '1', name: '中国银行', cardNumber: '1234', balance: 5000.00 },
                { id: '2', name: '建设银行', cardNumber: '5678', balance: 3000.00 }
            ];
            
            state.records = [
                { id: '1', bankId: '1', bankName: '中国银行', type: 'expense', amount: 150.00, remark: '餐饮', date: new Date(Date.now() - 86400000).toISOString() },
                { id: '2', bankId: '2', bankName: '建设银行', type: 'income', amount: 5000.00, remark: '工资', date: new Date(Date.now() - 172800000).toISOString() },
                { id: '3', bankId: '1', bankName: '中国银行', type: 'expense', amount: 200.00, remark: '购物', date: new Date(Date.now() - 259200000).toISOString() }
            ];
            
            showAlert('使用示例数据，请添加GitHub Gist配置以保存数据', 'info');
            debugLog('使用示例数据，本地存储为空', 'info');
        }
        
        // 保存Gist配置
        function saveGistConfig() {
            debugLog('开始保存Gist配置', 'info');
            
            const token = elements.gistToken.value.trim();
            const gistId = elements.gistId.value.trim();
            
            if (!token) {
                showAlert('请输入GitHub Personal Access Token', 'error');
                debugLog('保存Gist配置失败: Token为空', 'error');
                return;
            }
            
            // 验证token格式
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                showAlert('Token格式不正确。请确保使用有效的GitHub Personal Access Token', 'warning');
                debugLog('Token格式不正确，应以ghp_或github_pat_开头', 'warning');
            }
            
            state.gistToken = token;
            state.gistId = gistId;
            
            localStorage.setItem('gistToken', token);
            localStorage.setItem('gistId', gistId);
            
            showAlert('Gist配置保存成功', 'success');
            debugLog('Gist配置保存成功', 'success');
            debugLog(`Token长度: ${token.length} 字符`, 'info');
            debugLog(`Gist ID: ${gistId || '未设置，将创建新的Gist'}`, 'info');
        }
        
        // 测试Gist连接
        async function testGistConnection() {
            debugLog('开始测试Gist连接', 'info');
            
            if (!state.gistToken) {
                showAlert('请先配置GitHub Token', 'error');
                debugLog('测试连接失败: 未配置Token', 'error');
                return;
            }
            
            try {
                showAlert('正在测试GitHub连接...', 'info');
                
                // 测试API连接
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${state.gistToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Token无效或已过期');
                    } else if (response.status === 403) {
                        throw new Error('权限不足，请确保Token有gist权限');
                    } else {
                        throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                    }
                }
                
                const userData = await response.json();
                debugLog(`GitHub用户: ${userData.login}`, 'success');
                
                // 测试Gist功能
                if (state.gistId) {
                    debugLog(`测试获取Gist: ${state.gistId}`, 'info');
                    const gistResponse = await fetch(`https://api.github.com/gists/${state.gistId}`, {
                        headers: {
                            'Authorization': `token ${state.gistToken}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (gistResponse.ok) {
                        debugLog('Gist连接测试成功', 'success');
                        showAlert(`GitHub连接成功！用户: ${userData.login}, Gist可访问`, 'success');
                    } else {
                        debugLog(`Gist访问失败: ${gistResponse.status}`, 'warning');
                        showAlert(`GitHub连接成功，但Gist ID可能无效。用户: ${userData.login}`, 'warning');
                    }
                } else {
                    debugLog('GitHub连接测试成功，但未设置Gist ID', 'success');
                    showAlert(`GitHub连接成功！用户: ${userData.login}。未设置Gist ID，保存时将创建新的Gist`, 'success');
                }
                
            } catch (error) {
                console.error('测试Gist连接失败:', error);
                debugLog(`测试连接失败: ${error.message}`, 'error');
                showAlert(`连接测试失败: ${error.message}`, 'error');
            }
        }
        
        // 从Gist加载数据 - 修复版本
        async function loadFromGist() {
            if (!state.gistToken) {
                showAlert('请先配置GitHub Token', 'error');
                debugLog('从Gist加载失败: 未配置Token', 'error');
                return;
            }
            
            if (!state.gistId) {
                showAlert('请先配置Gist ID', 'error');
                debugLog('从Gist加载失败: 未配置Gist ID', 'error');
                return;
            }
            
            try {
                showAlert('正在从Gist加载数据...', 'info');
                debugLog(`从Gist加载数据: ${state.gistId}`, 'info');
                
                const response = await fetch(`https://api.github.com/gists/${state.gistId}`, {
                    headers: {
                        'Authorization': `token ${state.gistToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('Gist不存在，请检查Gist ID');
                    } else if (response.status === 401 || response.status === 403) {
                        throw new Error('Token无效或权限不足');
                    } else {
                        throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                    }
                }
                
                const gistData = await response.json();
                debugLog(`Gist获取成功: ${gistData.description || '无描述'}`, 'success');
                
                // 查找accounting.json文件
                const files = Object.values(gistData.files);
                const accountingFile = files.find(file => 
                    file.filename === 'accounting.json' || 
                    file.filename.includes('accounting') ||
                    file.filename.endsWith('.json')
                );
                
                if (!accountingFile) {
                    throw new Error('Gist中未找到记账数据文件');
                }
                
                debugLog(`找到文件: ${accountingFile.filename}, 大小: ${accountingFile.size} 字节`, 'info');
                debugLog(`文件内容前200字符: ${accountingFile.content.substring(0, 200)}...`, 'info');
                
                let appData;
                try {
                    appData = JSON.parse(accountingFile.content);
                } catch (parseError) {
                    debugLog(`JSON解析失败: ${parseError.message}`, 'error');
                    debugLog(`原始内容: ${accountingFile.content}`, 'error');
                    throw new Error(`JSON解析失败: ${parseError.message}`);
                }
                
                // 验证数据格式
                if (!appData) {
                    throw new Error('解析后的数据为空');
                }
                
                if (!Array.isArray(appData.banks)) {
                    debugLog('警告: banks不是数组，尝试修复数据格式', 'warning');
                    appData.banks = [];
                }
                
                if (!Array.isArray(appData.records)) {
                    debugLog('警告: records不是数组，尝试修复数据格式', 'warning');
                    appData.records = [];
                }
                
                debugLog(`解析数据: ${appData.banks.length} 张银行卡, ${appData.records.length} 条记录`, 'success');
                
                // 检查银行数据是否包含必要字段
                if (appData.banks.length > 0) {
                    const sampleBank = appData.banks[0];
                    debugLog(`银行示例数据: ${JSON.stringify(sampleBank)}`, 'info');
                    
                    // 确保银行数据有必要的字段
                    appData.banks = appData.banks.map(bank => {
                        return {
                            id: bank.id || Date.now().toString(),
                            name: bank.name || '未知银行',
                            cardNumber: bank.cardNumber || '0000',
                            balance: typeof bank.balance === 'number' ? bank.balance : 0
                        };
                    });
                }
                
                // 检查记录数据是否包含必要字段
                if (appData.records.length > 0) {
                    const sampleRecord = appData.records[0];
                    debugLog(`记录示例数据: ${JSON.stringify(sampleRecord)}`, 'info');
                }
                
                // 更新应用状态
                state.banks = appData.banks || [];
                state.records = appData.records || [];
                
                debugLog(`更新后状态: ${state.banks.length} 张银行卡, ${state.records.length} 条记录`, 'success');
                
                // 如果加载的数据为空，显示警告
                if (state.banks.length === 0 && state.records.length === 0) {
                    debugLog('警告: 从Gist加载的数据为空', 'warning');
                    showAlert('从Gist加载的数据为空，请检查Gist文件内容', 'warning');
                }
                
                // 更新UI
                updateUI();
                saveToLocalStorage();
                
                showAlert(`从Gist加载数据成功: ${state.banks.length} 张银行卡, ${state.records.length} 条记录`, 'success');
                debugLog('从Gist加载数据成功', 'success');
                
            } catch (error) {
                console.error('从Gist加载数据失败:', error);
                debugLog(`从Gist加载失败: ${error.message}`, 'error');
                showAlert(`从Gist加载数据失败: ${error.message}`, 'error');
                
                // 显示更多调试信息
                debugLog(`当前Gist ID: ${state.gistId}`, 'error');
                debugLog(`当前Token长度: ${state.gistToken.length}`, 'error');
            }
        }
        
        // 保存数据到Gist
        async function saveToGist() {
            if (!state.gistToken) {
                showAlert('请先配置GitHub Token', 'error');
                debugLog('保存到Gist失败: 未配置Token', 'error');
                return;
            }
            
            try {
                showAlert('正在保存数据到Gist...', 'info');
                debugLog('开始保存数据到Gist', 'info');
                debugLog(`当前数据: ${state.banks.length} 张银行卡, ${state.records.length} 条记录`, 'info');
                
                // 准备应用数据
                const appData = {
                    banks: state.banks,
                    records: state.records,
                    version: '2.0',
                    updatedAt: new Date().toISOString()
                };
                
                const content = JSON.stringify(appData, null, 2);
                debugLog(`数据大小: ${content.length} 字符`, 'info');
                debugLog(`数据内容预览: ${content.substring(0, 200)}...`, 'info');
                
                let gistId = state.gistId;
                let isNewGist = false;
                
                // 如果已有Gist ID，则更新现有Gist
                if (gistId) {
                    debugLog(`更新现有Gist: ${gistId}`, 'info');
                    const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `token ${state.gistToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            description: '个人记账系统数据 - 更新于 ' + new Date().toLocaleString(),
                            files: {
                                'accounting.json': {
                                    content: content
                                }
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('Gist不存在，请检查Gist ID');
                        } else {
                            throw new Error(`更新Gist失败: ${response.status} ${response.statusText}`);
                        }
                    }
                    
                    debugLog('Gist更新成功', 'success');
                } else {
                    // 否则创建新的Gist
                    debugLog('创建新的Gist', 'info');
                    const response = await fetch('https://api.github.com/gists', {
                        method: 'POST',
                        headers: {
                            'Authorization': `token ${state.gistToken}`,
                            'Accept': 'application/vnd.github.v3+json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            description: '个人记账系统数据',
                            public: false,
                            files: {
                                'accounting.json': {
                                    content: content
                                }
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`创建Gist失败: ${response.status} ${response.statusText}`);
                    }
                    
                    const gistData = await response.json();
                    gistId = gistData.id;
                    isNewGist = true;
                    
                    // 更新状态和本地存储
                    state.gistId = gistId;
                    localStorage.setItem('gistId', gistId);
                    elements.gistId.value = gistId;
                    
                    debugLog(`新Gist创建成功: ${gistId}`, 'success');
                }
                
                showAlert(`数据保存到Gist成功${isNewGist ? ' (已创建新Gist)' : ''}`, 'success');
                debugLog(`数据保存到Gist成功: ${gistId}`, 'success');
                
            } catch (error) {
                console.error('保存数据到Gist失败:', error);
                debugLog(`保存到Gist失败: ${error.message}`, 'error');
                showAlert(`保存数据到Gist失败: ${error.message}`, 'error');
            }
        }
        
        // 使deleteBank和deleteRecord函数在全局可访问
        window.deleteBank = deleteBank;
        window.deleteRecord = deleteRecord;
        window.debugLog = debugLog; // 方便在控制台调试
    </script>
</body>
</html>
